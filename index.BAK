
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="png" href="png/icon.PNG">
    <title>Test</title>
    <script src="phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>


<script type="text/javascript">

/***
ToDo
    ボタンの実装、表示、押したときの動作
    eating実装
    grooming実装
    コントラを見立てた外部ステータス格納区域の実装と、読み込み、書き込みの実装
    キャラのステータスをテキストで描写, コントラから定期的に取得し計算する
    ステータスはキャラクラスに保持させずに、コントラに見立てた外部変数に格納する。
    1日1回？feeding, last_feeding_timeからの差でexp加算, 24hr以上の差は無効
    satiety, happy, expのバーを実装する
    Lvを実装する。必要expの対応表を作製する。
    satietyとhappyの差別化を考える。
    fake contractにfeeding(), grooming(), lv_up()を実装する
    working()の概念を考える
***/


// class

/***
A, behavior
    1, resting
    2, moving
    3, eating
    4, sleeping
    5, grooming
    6, working
B, dynamic_status
    lif: -working/+sleeping
    nutirition: +eating
    happy: +grooming
    exp: +working
    coin: +working
C, static_status
    strength
    dexterity
    vitality
    intelligence
    luck
***/


const version = "0.0.14";
let turn = 0;


//static_status, read from construct at once
let local_id;
let local_type;
let local_strength;
let local_dexterity;
let local_vitality;
let local_intelligence;
let local_luck;
let local_birth_time;
//dynamic_status, read from construct continuously, write to construct
let local_last_feeding_time = Date.now() + 864000;
let local_last_grooming_time = Date.now() + 864000;
let local_coin;
let local_working_status;
let local_working_start_time;
let local_exp;


//fake contract
class Contract {
    constructor() {
        this.id = "001";
        this.type = Math.trunc(Math.random() * 5);
        this.strength = 2 + Math.trunc(Math.random() * 8);
        this.dexterity = 2 + Math.trunc(Math.random() * 8);
        this.vitality = 2 + Math.trunc(Math.random() * 8);
        this.intelligence = 2 + Math.trunc(Math.random() * 8);
        this.luck = 2 + Math.trunc(Math.random() * 8);
        this.birth_time = Date.now();
        this.last_feeding_time = Date.now();
        this.last_grooming_time = Date.now();
        this.coin = 100;
        this.working_status = 0;
        this.working_start_time = 0;
        this.exp = 0;
    }
}


class Character extends Phaser.GameObjects.Sprite{
    constructor(scene, x, y){
        super(scene, x, y, "murasaki_right");
        this.scene.add.existing(this);
        this.anims.play("murasaki_right", true);
    	this.mode = "resting";
        this.count = 0;
        this.dist = "right";
    }
    set set_mode(mode){
        this.mode = mode;
        this.count = 0;
    }
    get get_mode(){
        return this.mode;
    }
    resting(){
	    this.count += 1;
        if (this.count == 1) {
            if (this.dist == "right"){
                this.anims.play("murasaki_right", true);
            }else if (this.dist == "left") {
                this.anims.play("murasaki_left", true);
            }
	    }else if (this.count >= 100){
            let tmp = Math.random() * 100;
            if (tmp <= 10) {
                this.mode = "sleeping";
                this.count = 0;
            }else if (tmp <= 20) {
                this.mode = "crying";
                this.count = 0;
            }else {
                this.mode = "moving";
                this.count = 0;
            }
        }
    }
    moving() {
        this.count += 1;
        if (this.count == 1){
            if (this.x <= 100) {
                this.dist = "right";
            }else if (this.x >= 700) {
                this.dist = "left";
            }else {
                var li = ["right", "left"];
                this.dist = li[Math.floor(Math.random() * li.length)];
            }
            if (this.dist == "right"){
                this.anims.play("murasaki_right", true);
            }else if (this.dist == "left") {
                this.anims.play("murasaki_left", true);
            }
        }else if (this.count < 100) {
            if (this.dist == "right" && this.count % 2 == 0){
                this.x += 1;
            }else if (this.dist == "left" && this.count % 2 == 0) {
                this.x -= 1;
            }
        }else if (this.count >= 100) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    //send: last_nutrition_time
    feeding() {
        this.count += 1;
        if (this.count == 1){
            this.anims.play("murasaki_feeding", true);
        }else if (this.count >= 1000) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    crying() {
        this.count += 1;
        if (this.count == 1){
            this.anims.play("murasaki_crying", true);
        }else if (this.count >= 500) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    sleeping() {
        this.count += 1;
        if (this.count == 1){
            this.anims.play("murasaki_sleeping", true);
        }else if (this.count >= 1000) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    //send: last_grooming_time
    grooming() {
        this.count += 1;
        if (this.count == 1){
            this.anims.play("murasaki_feeding", true);
        }else if (this.count >= 1000) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    //cost: life, gain: coin
    working() {
        this.count += 1;
    }
    update(){
        //console.log(this.version, this.mode, this.count);
        if (this.mode == "resting") {this.resting();}
        else if (this.mode == "moving") {this.moving();}
        else if (this.mode == "feeding") {this.feeding();}
        else if (this.mode == "crying") {this.crying();}
        else if (this.mode == "sleeping") {this.sleeping();}
        else if (this.mode == "grooming") {this.grooming();}
        else if (this.mode == "working") {this.working();}
    }
}


class Button {
    constructor(x, y, label, scene, callback) {
        let fontsize = 12;
        const button = scene.add.text(x, y, label)
            .setFontSize(fontsize)
            .setFontFamily("Arial")
            .setOrigin(0.5)
            .setPadding(10)
            //.setStyle({ backgroundColor: '#111' })
            .setInteractive({ useHandCursor: true })
            .on('pointerdown', () => callback())
            .on('pointerover', () => button.setStyle({ fontSize: fontsize, fontFamily: "Arial", fill: '#f39c12' }))
            .on('pointerout', () => button.setStyle({ fontSize: fontsize, fontFamily: "Arial", fill: '#FFF' }));
    }
}


function button_feeding(contract) {
    //char1.set_mode = "feeding";
    let delta = Date.now() - local_last_feeding_time;
    contract.exp += delta / 1000
    contract.last_feeding_time = Date.now();
}
function button_grooming(contract) {
    //char1.set_mode = "grooming";
    let delta = Date.now() - local_last_grooming_time;
    contract.exp += delta / 1000
    contract.last_grooming_time = Date.now();
}


function makeBar(scene, x, y, color) {
    //draw the bar
    let bar = scene.add.graphics();
    //color the bar
    bar.fillStyle(color, 1);
    //fill the bar with a rectangle
    bar.fillRect(0, 0, 100, 10);
    //position the bar
    bar.x = x;
    bar.y = y;
    //return the bar
    return bar;
}


// main functions


let config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    scale: {
        //autoCenter: Phaser.Scale.CENTER_HORIZONTALLY,
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    },
//    fps: {
//        target: 1,
//        forceSetTimeOut: true
//    }
};


let game = new Phaser.Game(config);


function preload() {
    this.load.image("sky", "png/sky.png");
    this.load.spritesheet("murasaki_right", "png/murasaki_right.png", {frameWidth: 74, frameHeight: 64});
    this.load.spritesheet("murasaki_left", "png/murasaki_left.png", {frameWidth: 74, frameHeight: 64});
    this.load.spritesheet("murasaki_sleeping", "png/murasaki_sleeping.png", {frameWidth: 74, frameHeight: 64});
    this.load.spritesheet("murasaki_feeding", "png/murasaki_feeding.png", {frameWidth: 74, frameHeight: 64});
    this.load.spritesheet("murasaki_crying", "png/murasaki_crying.png", {frameWidth: 74, frameHeight: 64});
    cursors = this.input.keyboard.createCursorKeys();
}


function create() {
    //fake contract
    contract = new Contract();
    this.add.image(400, 300, "sky");
    this.anims.create({
        key: "murasaki_right",
        frames: this.anims.generateFrameNumbers("murasaki_right", {start: 0, end:3}),
        frameRate: 2,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_left",
        frames: this.anims.generateFrameNumbers("murasaki_left", {start: 0, end:3}),
        frameRate: 2,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_sleeping",
        frames: this.anims.generateFrameNumbers("murasaki_sleeping", {start: 0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_feeding",
        frames: this.anims.generateFrameNumbers("murasaki_feeding", {start: 0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_crying",
        frames: this.anims.generateFrameNumbers("murasaki_crying", {start: 0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    //summon character
    char1 = new Character(this, 300 + Math.random()*200, 400 + Math.random()*100);
    //button
    const button1 = new Button(100, 25, 'Grooming', this, () => button_grooming(contract));
    const button2 = new Button(100, 50, 'Feeding', this, () => button_feeding(contract));
    //text
    text_version = this.add.text(600, 10, "version = " + version, {font: "10.5px Arial", fill: "#000"});
    //static_status
    text_id = this.add.text(
        600, 30, "id = " + local_id, {font: "10.5px Arial", fill: "#000"});
    text_type = this.add.text(
        600, 40, "type = " + local_type, {font: "10.5px Arial", fill: "#000"});
    text_birth_time = this.add.text(
        600, 50, "birth_time = " + local_birth_time, {font: "10.5px Arial", fill: "#000"});
    text_strength = this.add.text(
        600, 60, "strength = " + local_strength, {font: "10.5px Arial", fill: "#000"});
    text_dexterity = this.add.text(
        600, 70, "dexterity = " + local_dexterity, {font: "10.5px Arial", fill: "#000"});
    text_vitality = this.add.text(
        600, 80, "vitality = " + local_vitality, {font: "10.5px Arial", fill: "#000"});
    text_intelligence = this.add.text(
        600, 90, "intelligence = " + local_intelligence, {font: "10.5px Arial", fill: "#000"});
    text_luck = this.add.text(
        600, 100, "luck = " + local_luck, {font: "10.5px Arial", fill: "#000"});
    //dynamic_status
    text_last_feeding_time = this.add.text(
        600, 120, "last_feeding_time = " + local_last_feeding_time, {font: "10.5px Arial", fill: "#000"});
    text_last_grooming_time = this.add.text(
        600, 130, "last_grooming_time = " + local_last_grooming_time, {font: "10.5px Arial", fill: "#000"});
    text_coin = this.add.text(
        600, 140, "coin = " + local_coin, {font: "10.5px Arial", fill: "#000"});
    text_working_status = this.add.text(
        600, 150, "working_status = " + local_working_status, {font: "10.5px Arial", fill: "#000"});
    text_working_start_time = this.add.text(
        600, 160, "working_start_time = " + local_working_start_time, {font: "10.5px Arial", fill: "#000"});
    text_exp = this.add.text(
        600, 170, "exp = " + local_exp, {font: "10.5px Arial", fill: "#000"});
    //calculation_status
    text_turn = this.add.text(
        600, 190, "turn = ", {font: "10.5px Arial", fill: "#000"});
    text_age_time = this.add.text(
        600, 200, "age_time = ", {font: "10.5px Arial", fill: "#000"});
    text_mode = this.add.text(
        600, 210, "mode = ", {font: "10.5px Arial", fill: "#000"});
    text_satiety = this.add.text(
        600, 220, "satiey = ", {font: "10.5px Arial", fill: "#000"});
    text_happy = this.add.text(
        600, 230, "happy = ", {font: "10.5px Arial", fill: "#000"});
    //bar
    //satiety
    this.add.text(600, 250, "satiety:", {font: "10.5px Arial", fill: "#000"});
    bar_satiety_back = makeBar(this, 640, 250, 0xa9a9a9);
    bar_satiety_back.scaleX = 1;
    bar_satiety = makeBar(this, 640, 250, 0xff4500);
    bar_satiety.scaleX = 0;
    //happy
    this.add.text(600, 270, "happy:", {font: "10.5px Arial", fill: "#000"});
    bar_happy_back = makeBar(this, 640, 270, 0xa9a9a9);
    bar_happy_back.scaleX = 1;
    bar_happy = makeBar(this, 640, 270, 0x4169e1);
    bar_happy.scaleX = 0;
    //exp
    this.add.text(600, 290, "exp:", {font: "10.5px Arial", fill: "#000"});
    bar_exp_back = makeBar(this, 640, 290, 0xa9a9a9);
    bar_exp_back.scaleX = 1;
    bar_exp = makeBar(this, 640, 290, 0x228b22);
    bar_exp.scaleX = 0;
}


function update() {
    //update turn
    turn += 1;
    text_turn.setText("turn = " + turn);
    //update character
    char1.update();
    //update static status from contract at once
    if (turn == 1) {
        local_id = contract.id;
        local_type = contract.type;
        local_birth_time = contract.birth_time;
        local_strength = contract.strength;
        local_dexterity = contract.dexterity;
        local_vitality = contract.vitality;
        local_intelligence = contract.intelligence;
        local_luck = contract.luck;
        text_id.setText("id = " + local_id);
        text_type.setText("type = " + local_type);
        text_birth_time.setText("birth_time = " + local_birth_time);
        text_strength.setText("strength = " + local_strength);
        text_dexterity.setText("dexterity = " + local_dexterity);
        text_vitality.setText("vitality = " + local_vitality);
        text_intelligence.setText("intelligence = " + local_intelligence);
        text_luck.setText("luck = " + local_luck);
    }
    //update calculation status
    if (turn % 10 == 0) {
        //update calculation_status
        let now_time = Date.now();
        let age_time = Math.round( (now_time - local_birth_time) / 1000 );
        let mode = char1.get_mode;
        //var base = 86400000
        let base = 864000
        let satiety = Math.round( (base - (now_time - local_last_feeding_time)) / base * 1000 ) / 10;
        if (satiety < 0) { satiety = 0; }
        let happy = Math.round( (base - (now_time - local_last_grooming_time)) / base * 1000 ) / 10;
        if (happy < 0) { happy = 0; }
        //update text
        text_last_feeding_time.setText("last_feeding_time = " + local_last_feeding_time);
        text_last_grooming_time.setText("last_grooming_time = " + local_last_grooming_time);
        text_coin.setText("coin = " + local_coin);
        text_working_status.setText("working_status = " + local_working_status);
        text_working_start_time.setText("working_start_time = " + local_working_start_time);
        text_exp.setText("exp = " + local_exp);
        text_age_time.setText("age_time = " + age_time);
        text_mode.setText("mode = " + mode);
        text_satiety.setText("satiety = " + satiety);
        text_happy.setText("happy = " + happy);
        //update bar
        bar_satiety.scaleX = satiety / 100;
        bar_happy.scaleX = happy / 100;
        let exp = local_exp / 1000;
        if (exp > 100) { exp = 100; }
        bar_exp.scaleX = exp / 1000;
    }
    //update dynamic status from contract to local
    if (turn % 101 == 0) {
        //update statistic_status
        //update dynamic_status
        //TODO: read from contract
        let previous_local_last_feeding_time = local_last_feeding_time;
        let previous_local_last_grooming_time = local_last_grooming_time;
        local_last_feeding_time = contract.last_feeding_time;
        local_last_grooming_time = contract.last_grooming_time;
        local_coin = contract.coin;
        local_working_status = contract.working_status;
        local_working_start_time = contract.working_start_time;
        local_exp = contract.exp;
        //check character mode
        if (local_last_feeding_time > previous_local_last_feeding_time){
            //console.log("feeding");
            char1.set_mode = "feeding";
        }
        if (local_last_grooming_time > previous_local_last_grooming_time){
            //console.log("grooming");
            char1.set_mode = "grooming";
        }
    }
}


</script>


</body>
</html>
