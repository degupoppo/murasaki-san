
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="png" href="png/icon.PNG">
    <title>House of Murasaki San</title>
    <script src="phaser.js"></script>
    <script src="web3.min.js"></script>
    <script src="abi_contract3.js"></script>
    <style type="text/css">
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        html {
            display: table;
        }
        body {
            margin: 0;
            display: table-cell;
            text-align: center;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <input type="button" value="[ Summon ]" onclick="contract_summon(1);" />
    <br>
    <input type="button" value="[ Update your Summoners â†’ ]" onclick="button_update_summoners();" />
    &nbsp;
    <form name="select_summoner">
        <select name="select_summoner" id="summoner">
            <option value="***">***<option>
        </select>
    </form>
    &nbsp;
    <input type="button" value="[ Start! ]" onclick="button_select_summoner();" />
    <br>

<script type="text/javascript">



//global variants
//--------------------------------------------------------------------------------------------------------

let summoner = -1;



//web3
//--------------------------------------------------------------------------------------------------------

//connect to metamask
async function connect() {
    const web3 = await new Web3(window.ethereum);
    window.ethereum.enable();
    window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
            chainId: '0x51',  //4369
            chainName: 'Shibuya Testnet',
            nativeCurrency: {
                name: 'sby',
                symbol: 'SBY',
                decimals: 18
            },
            rpcUrls: ["https://rpc.shibuya.astar.network:8545"],
            blockExplorerUrls: ['https://blockscout.com/shibuya'],
        }]
    });
    return web3;
}

//get wallet
async function get_wallet(web3) {
    const wallet = await web3.eth.getAccounts();
    return wallet[0];
}

//prepare contract, need abi_contract.js
async function get_contract(web3) {
    const contract = await new web3.eth.Contract(abi, contract_address);
    return contract;
}


async function contract_update_status(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let res = await contract.methods.get_status(summoner).call();
    console.log(res);   
    local_ctype = res[0];
    local_strength = res[1];
    local_dexterity = res[2];
    local_vitality = res[3];
    local_intelligence = res[4];
    local_luck = res[5];
    local_birth_time = res[6];
    local_last_feeding_time = res[7];
    local_last_grooming_time = res[8];
    local_coin = res[9];
    local_material = res[10];
    local_mining_status = res[11];
    local_mining_start_time = res[12];
    local_farming_status = res[13];
    local_farming_start_time = res[14];
    local_crafting_status = res[15];
    local_crafting_start_time = res[16];
    local_exp = res[17];
    local_level = res[18];
    local_next_exp_required = res[19];
}

//call status from contract

//summon
async function contract_summon(ctype) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    contract.methods.summon(ctype).send({from:wallet});
}

//get owned summoners
async function contract_my_summoners() {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    let next_summoner = await contract.methods.next_summoner().call();
    let res = [];
    for (let i = 0; i < next_summoner; i++) {
        let owner = await contract.methods.ownerOf(i).call();
        if (owner == wallet) {
            res.push({text:i, value:i});
        }
    }
    console.log(res);
    return res;
}

//update select list
function _create_dropdownlist( form_name, select_name, select_array ){
	document[form_name][select_name].length = select_array.length;
	var i;
	for ( i=0; i<select_array.length; i++){
		document[form_name][select_name].options[i].text = select_array[i].text;
		document[form_name][select_name].options[i].value = select_array[i].value;
	}
}

//update summoner list
async function button_update_summoners() {
    opt_array = await contract_my_summoners();
    _create_dropdownlist("select_summoner","select_summoner", opt_array )
}

//update summoner
function button_select_summoner() {
    summoner = document.getElementById("summoner").value;
    window.location.href = "index3-2.html?summoner=" + summoner;
}

//update summoner list
async function button_summon() {
    opt_array = await contract_my_summoners();
    _create_dropdownlist("select_summoner","select_summoner", opt_array )
}


</script>

<!---
Donate: 0x2F7448B62134e52C2f46454d0089Ae21B5248805
--->

</body>
</html>
