<!DOCTYPE html>
<html lang="ja">

<!---

https://tky-advinfo.com/programing/datatables/
jQueryのDataTablesプラグインを使用

項目
    _item ID
    _item_type (Name, Normal/Rare)
    price
    crafted summoner
    crafted time

ToDo
    item listの取得の実装
    テーブル化の実装
    Buyボタンの実装
    Listボタンの実装
    Unlistボタンの実装
    所有item一覧表示の実装

--->

<script src="js_v2/web3.min.js"></script>
<script src="js_v2/murasaki_item_market.js"></script>
<script src="js_v2/murasaki_craft.js"></script>
<script src="js_v2/big-number.js"></script>
<script src="js_v2/array_item_name.js"></script>
<script src="js_v2/murasaki_main.js"></script>

<script type="text/javascript">

    //connect to metamask
    async function connect() {
        const web3 = await new Web3(window.ethereum);
        window.ethereum.enable();
        window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
                chainId: '0x51',  //4369
                chainName: 'Shibuya Testnet',
                nativeCurrency: {
                    name: 'sby',
                    symbol: 'SBY',
                    decimals: 18
                },
                rpcUrls: ["https://rpc.shibuya.astar.network:8545"],
                blockExplorerUrls: ['https://blockscout.com/shibuya'],
            }]
        });
        return web3;
    }

    //get wallet
    async function get_wallet() {
        let web3 = await connect();
        let wallet = await web3.eth.getAccounts();
        return wallet[0];
    }

    //get items on market
    async function update_onMarketItems() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        //contract
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        let contract_mc = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        let ListLength = await contract.methods.listLength().call();
        let ListsAt = await contract.methods.listsAt(0, ListLength).call();
        for (let i = 0; i < ListLength; i++) {
            let _item = ListsAt[0][i];
            let _price = ListsAt[1][i];
            let _items = await contract_mc.methods.items(_item).call();
            let _item_type = _items[0];
            let _crafted_summoner = _items[2];
            let _html = "";
            _html += "<tr><td><center>"
            _html += _item;
            _html += "</center></td><td><center>";
            //_html += _item_type;
            _html += array_item_name[_item_type];
            _html += "</center></td><td><center>";
            _html += _crafted_summoner;
            _html += "</center></td><td id='" + "input_price_" + _item + "'><center><b>";
            _html += (Math.round(_price/(10**18)*100)/100).toFixed(2);
            _html += "</b></center></td><td><center>";
            _html += "<button onclick='buy_item(" + _item + "," + _price + ");'>";
            _html += "Buy";
            _html += "</button>";
            _html += "</center></td></tr>";
            tbody_sellingItems.innerHTML += _html;
        }
        //after loading, activate JQuery CSS
        $(document).ready(function(){
           $('#table_onMarketItems').DataTable();
        });
    }

    //get selling items of listed
    async function update_sellingItems() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        //contract
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        let contract_mc = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        let myListLength = await contract.methods.myListLength(wallet).call();
        let myListsAt = await contract.methods.myListsAt(wallet, 0, myListLength).call();
        for (let i = 0; i < myListLength; i++) {
            let _item = myListsAt[0][i];
            let _price = myListsAt[1][i];
            let _items = await contract_mc.methods.items(_item).call();
            let _item_type = _items[0];
            let _crafted_summoner = _items[2];
            let _html = "";
            _html += "<tr><td><center>"
            _html += _item;
            _html += "</center></td><td><center>";
            _html += array_item_name[_item_type];
            _html += "</center></td><td><center>";
            _html += _crafted_summoner;
            _html += "</center></td><td><center><b>";
            _html += (Math.round(_price/(10**18)*100)/100).toFixed(2);
            _html += "</b></center></td><td><center>";
            _html += "<button onclick='unlist_item(" + _item + ");'>";
            _html += "Unlist";
            _html += "</button>";
            _html += "</center></td></tr>";
            tbody_listedItems.innerHTML += _html;
        }
        //after loading, activate JQuery CSS
        $(document).ready(function(){
           $('#talbe_sellingItems').DataTable();
        });
    }

    //get items of users
    async function update_userItems() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        //contract
        let contract = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        let myListLength = await contract.methods.myListLength(wallet).call();
        let myListsAt = await contract.methods.myListsAt(wallet, 0, myListLength).call();
        for (let i = 0; i < myListLength; i++) {
            let _item = myListsAt[i];
            _items = await contract.methods.items(_item).call();
            let _item_type = _items[0];
            let _crafted_time = _items[1];
            let _crafted_summoner = _items[2];
            let _crafted_wallet = _items[3];
            let _wallet1 = _crafted_wallet.substring(0,5);
            let _wallet2 = _crafted_wallet.slice(-4);
            //console.log(_item, _item_type, _crafted_time, _crafted_summoner, _crafted_wallet);
            let _html = "";
            _html += "<tr><td><center>"
            _html += _item;
            _html += "</center></td><td><center>";
            _html += array_item_name[_item_type];
            _html += "</center></td><td><center>";
            _html += _crafted_time;
            _html += "</center></td><td><center>";
            _html += _crafted_summoner;
            //_html += "</center></td><td><center>";
            //_html += _wallet1 + "..." + _wallet2;
            _html += "</center></td><td><center>";
            _html += "<input type='number' id='" + "input_price_" + _item + "'>";
            _html += "&nbsp;&nbsp;";
            _html += "<button onclick='list_item(" + _item + ");'>";
            _html += "List";
            _html += "</button>";
            _html += "</center></td></tr>";
            tbody_myItems.innerHTML += _html;
        }
        //after loading, activate JQuery CSS
        $(document).ready(function(){
           $('#table_userItems').DataTable();
        });
    }

    //buy item
    async function buy_item(_item, _price) {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        await contract.methods.buy(_item).send({from: wallet, value: _price});
    }

    //unlist item
    async function unlist_item(_item) {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        await contract.methods.unlist(_item).send({from:wallet});
    }

    //list item
    async function list_item(_item) {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let _price = new BigNumber(document.getElementById("input_price_"+_item).value * 10**18);
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        await contract.methods.list(_item, _price).send({from:wallet});
    }
    
    //approve
    async function approve() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let contract = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        //console.log(await contract.methods.isApprovedForAll(wallet, contract_murasaki_item_market).call());
        await contract.methods.setApprovalForAll(contract_murasaki_item_market, true).send({from:wallet});
    }
    
    //check_approve
    async function check_approve() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let contract = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        let _res = await contract.methods.isApprovedForAll(wallet, contract_murasaki_item_market).call();
        console.log(_res);
        if (_res == true) {
            document.getElementById("button_approve").disabled = true;
            document.getElementById("button_approve").firstChild.data = "Approved";
        }
    }
    
    //transfer item
    async function transfer_item() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let contract_mm = await new web3.eth.Contract(abi_murasaki_main, contract_murasaki_main);
        let _item = document.getElementById("transfer_item_id").value;
        let _to_summoner = document.getElementById("transfer_summoner").value;
        let _to_wallet = await contract_mm.methods.ownerOf(_to_summoner).call();
        let contract = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        contract.methods.safeTransferFrom(wallet, _to_wallet, _item).send({from:wallet});
    }

</script>

<head>
	<meta charset="UTF-8">
	<title>Murasaki-san Item Market</title>
	<link rel="stylesheet" type="text/css" href="./market/datatables.min.css"/>
	<script type="text/javascript" language="javascript" src="./market/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" language="javascript" src="./market/datatables.min.js"></script>
    <link rel="stylesheet" href="assets/css/simple.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="png/icon.PNG" />
    <link rel="apple-touch-icon" href="png/icon.PNG">
</head>

<body>

<header>
    <nav>
      <a href="/">Home</a>
      <a href="/dapp.html" ><b>Play the Game</b></a>
      <a href="/market.html" class="current"><b>Item Market</b></a>
      <a href="/dapp.html?summoner=1">Demo Preview</a>
      <a href="https://twitter.com/degupoppo" >Twitter</a>
      <a href="https://github.com/degupoppo/murasakisan/" >GitHub</a>
    </nav>
    <h1>
        <img src="png/food_sweet_potato.png" width="40" height="40">
        Item Market Place
        <img src="png/food_sweet_potato.png" width="40" height="40">
    </h1>
    <p><code class="language-plaintext highlighter-rouge">
        You can buy and sell crafted item NFTs here.<br>
        All transaction fees are 1%. <br>
    </p></code>
</header>

<main>

    <h3>Item Market</h3>
	<table id="table_onMarketItems" class="display">
		<thead><tr>
			<th style="width:50px;"><center>item_id</center></th>
			<th><center>item_type</center></th>
			<th><center>crafted_by</center></th>
			<th><center>Price ($ASTR)</center></th>
			<th><center>action</center></th>
		</tr></thead>
		<tbody id="tbody_sellingItems"></tbody>
	</table>

    <h3>Your Sellings</h3>
	<table id="talbe_sellingItems" class="display">
		<thead><tr>
			<th style="width:50px;"><center>item_id</center></th>
			<th><center>item_type</center></th>
			<th><center>crafted_by</center></th>
			<th><center>Price ($ASTR)</center></th>
			<th><center>action</center></th>
		</tr></thead>
		<tbody id="tbody_listedItems"></tbody>
	</table>

    <h3>Your Items</h3>
    <p><code class="language-plaintext highlighter-rouge">
        Before selling, please approve the Market Contract:
        <button id="button_approve" onclick='approve();'>Approve</button><br>
    </code></p>
	<table id="table_userItems" class="display">
	    <thead><tr>
            <th style="width:50px;"><center>item_id</center></th>
            <th><center>item_type</center></th>
            <th><center>crafted_at</center></th>
            <th><center>crafted_by</center></th>
            <th><center>selling Price ($ASTR)</center></th>
        </tr></thead>
        <tbody id="tbody_myItems"></tbody>
	</table>

	<p>
	<b>Send your items to other Murasaki-san:</b><br>
    item_id: <input type="number" id="transfer_item_id" style="width:80px;">
    &nbsp;&nbsp;to Murasaki-san: <input type="number" id="transfer_summoner" style="width:80px;">
    &nbsp;&nbsp;<button onclick="transfer_item();">Send Item</button>
    </p>

	<p>
	<b>Upgrade items to a higher rarity item:</b><br>
	Mint a higher rarity item by consuming 3 items with the same item_type and rarity<br>
    item_id: <input type="number" id="upgrade_item_id1" style="width:80px;">
    &nbsp;item_id: <input type="number" id="upgrade_item_id2" style="width:80px;">
    &nbsp;item_id: <input type="number" id="upgrade_item_id3" style="width:80px;">
    &nbsp;&nbsp;<button onclick="upgrade_item();" disabled>Upgrade Item</button>
    </p>

    <script>
        update_onMarketItems();
        update_sellingItems();
        update_userItems();
        check_approve();
    </script>

</main>

<footer>
    <p>
        Donation: 0x2F7448B62134e52C2f46454d0089Ae21B5248805<br>
    </p>
</footer>

</body>
</html>
