<!DOCTYPE html>
<html lang="ja">

<!---

https://tky-advinfo.com/programing/datatables/
jQueryのDataTablesプラグインを使用

項目
    _item ID
    _item_type (Name, Normal/Rare)
    price
    crafted summoner
    crafted time

ToDo
    item listの取得の実装
    テーブル化の実装
    Buyボタンの実装
    Listボタンの実装
    Unlistボタンの実装
    所有item一覧表示の実装

--->

<script src="js_v2/web3.min.js"></script>
<script src="js_v2/murasaki_item_market.js"></script>
<script src="js_v2/murasaki_craft2.js"></script>
<script src="js_v2/big-number.js"></script>

<script type="text/javascript">

    //connect to metamask
    async function connect() {
        const web3 = await new Web3(window.ethereum);
        window.ethereum.enable();
        window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
                chainId: '0x51',  //4369
                chainName: 'Shibuya Testnet',
                nativeCurrency: {
                    name: 'sby',
                    symbol: 'SBY',
                    decimals: 18
                },
                rpcUrls: ["https://rpc.shibuya.astar.network:8545"],
                blockExplorerUrls: ['https://blockscout.com/shibuya'],
            }]
        });
        return web3;
    }

    //get wallet
    async function get_wallet() {
        let web3 = await connect();
        let wallet = await web3.eth.getAccounts();
        return wallet[0];
    }

    //get items of wallet
    async function update_myItems() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        //contract
        let contract = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        let myListLength = await contract.methods.myListLength(wallet).call();
        let myListsAt = await contract.methods.myListsAt(wallet, 0, myListLength).call();
        //console.log(myListsAt);
        let _items;
        tbody_myItems.innerHTML = "";
        for (let i = 0; i < myListLength; i++) {
            let _item = myListsAt[i];
            _items = await contract.methods.items(_item).call();
            //console.log(_item, _items);
            let _item_type = _items[0];
            let _crafted_time = _items[1];
            let _crafted_summoner = _items[2];
            let _crafted_wallet = _items[3];
            let _wallet1 = _crafted_wallet.substring(0,5);
            let _wallet2 = _crafted_wallet.slice(-4);
            //console.log(_item, _item_type, _crafted_time, _crafted_summoner, _crafted_wallet);
            let _html = "";
            _html += "<tr><td><center>"
            _html += _item;
            _html += "</center></td><td><center>";
            _html += _item_type;
            _html += "</center></td><td><center>";
            _html += _crafted_time;
            _html += "</center></td><td><center>";
            _html += _crafted_summoner;
            //_html += "</center></td><td><center>";
            //_html += _wallet1 + "..." + _wallet2;
            _html += "</center></td><td><center>";
            _html += "<input type='number' id='" + "input_price_" + _item + "'>";
            _html += "&nbsp;&nbsp;";
            _html += "<button onclick='list_item(" + _item + ");'>";
            _html += "List";
            _html += "</button>";
            _html += "</center></td></tr>";
            //console.log(_html);
            tbody_myItems.innerHTML += _html;
        }
        //after loading, activate JQuery CSS
        $(document).ready(function(){
           $('#table_myItems').DataTable();
        });
    }

    //get items of listed
    async function update_listedItems() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        //contract
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        let contract_mc = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        let myListLength = await contract.methods.myListLength(wallet).call();
        let myListsAt = await contract.methods.myListsAt(wallet, 0, myListLength).call();
        //console.log(myListLength, myListsAt);
        //console.log(myListsAt[0]);
        let _items;
        tbody_listedItems.innerHTML = "";
        for (let i = 0; i < myListLength; i++) {
            let _item = myListsAt[0][i];
            let _price = myListsAt[1][i];
            let _items = await contract_mc.methods.items(_item).call();
            let _item_type = _items[0];
            let _html = "";
            _html += "<tr><td><center>"
            _html += _item;
            _html += "</center></td><td><center>";
            _html += _item_type;
            _html += "</center></td><td><center>";
            _html += (Math.round(_price/(10**18)*100)/100).toFixed(2);
            _html += "</center></td><td><center>";
            _html += "<button onclick='unlist_item(" + _item + ");'>";
            _html += "Unlist";
            _html += "</button>";
            _html += "</center></td></tr>";
            //console.log(_html);
            tbody_listedItems.innerHTML += _html;
        }
        //after loading, activate JQuery CSS
        $(document).ready(function(){
           $('#table_listedItems').DataTable();
        });
    }

    //get items of selling
    async function update_sellingItems() {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        //contract
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        let contract_mc = await new web3.eth.Contract(abi_murasaki_craft, contract_murasaki_craft);
        let ListLength = await contract.methods.listLength().call();
        let ListsAt = await contract.methods.listsAt(0, ListLength).call();
        let _items;
        tbody_sellingItems.innerHTML = "";
        for (let i = 0; i < ListLength; i++) {
            let _item = ListsAt[0][i];
            let _price = ListsAt[1][i];
            let _items = await contract_mc.methods.items(_item).call();
            let _item_type = _items[0];
            let _crafted_summoner = _items[2];
            let _html = "";
            _html += "<tr><td><center>"
            _html += _item;
            _html += "</center></td><td><center>";
            _html += _item_type;
            _html += "</center></td><td><center>";
            _html += _crafted_summoner;
            _html += "</center></td><td id='" + "input_price_" + _item + "'><center>";
            _html += (Math.round(_price/(10**18)*100)/100).toFixed(2);
            _html += "</center></td><td><center>";
            _html += "<button onclick='buy_item(" + _item + "," + _price + ");'>";
            _html += "Buy";
            _html += "</button>";
            _html += "</center></td></tr>";
            //console.log(_html);
            tbody_sellingItems.innerHTML += _html;
        }
        //after loading, activate JQuery CSS
        $(document).ready(function(){
           $('#table_sellingItems').DataTable();
        });
    }

    //list item
    async function list_item(_item) {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let _price = new BigNumber(document.getElementById("input_price_"+_item).value * 10**18);
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        await contract.methods.list(_item, _price).send({from:wallet});
    }

    //unlist item
    async function unlist_item(_item) {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        await contract.methods.unlist(_item).send({from:wallet});
    }

    //buy item
    async function buy_item(_item, _price) {
        let web3 = await connect();
        let wallet = await get_wallet(web3);
        let contract = await new web3.eth.Contract(abi_murasaki_item_market, contract_murasaki_item_market);
        await contract.methods.buy(_item).send({from: wallet, value: _price});
    }

</script>

<head>
	<meta charset="UTF-8">
	<title>DataTables example</title>
	<link rel="stylesheet" type="text/css" href="./market/datatables.min.css"/>
	<script type="text/javascript" language="javascript" src="./market/jquery-3.6.0.min.js"></script>
	<script type="text/javascript" language="javascript" src="./market/datatables.min.js"></script>
    <link rel="stylesheet" href="assets/css/simple.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="png/icon.PNG" />
    <link rel="apple-touch-icon" href="png/icon.PNG">
</head>

<body>

    <h3>Buy item</h3>
	<table id="table_sellingItems" class="display">
		<thead>
			<tr>
				<th style="width:50px;"><center>item_id</center></th>
				<th><center>item_type</center></th>
				<th><center>crafted_by</center></th>
				<th><center>Price ($ASTR)</center></th>
				<th></th>
			</tr>
		</thead>
		<tbody id="tbody_sellingItems">
		</tbody>
	</table>

    <h3>List your item</h3>
	<table id="table_myItems" class="display">
		<thead>
			<tr>
				<th style="width:50px;"><center>item_id</center></th>
				<th><center>item_type</center></th>
				<th><center>crafted_at</center></th>
				<th><center>crafted_by</center></th>
				<th><center>sell Price ($ASTR)</center></th>
			</tr>
		</thead>
		<tbody id="tbody_myItems">
		</tbody>
	</table>
	
	
    <h3>Unlist item</h3>
	<table id="table_listedItems" class="display">
		<thead>
			<tr>
				<th style="width:50px;"><center>item_id</center></th>
				<th><center>item_type</center></th>
				<th><center>listed_price</center></th>
				<th><center>unlist</center></th>
			</tr>
		</thead>
		<tbody id="tbody_listedItems">
		</tbody>
	</table>
<br>
<br>
<br>
<script>
    update_sellingItems();
    update_myItems();
    update_listedItems();
</script>

</body>
</html>
