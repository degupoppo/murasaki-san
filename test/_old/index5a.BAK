
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="png" href="png/icon.PNG">
    <title>House of Murasaki-San</title>
    <script src="js_local/web3.min.js"></script>
    <script src="js_local/murasaki_main.js"></script>
    <style type="text/css">
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        html {
            display: table;
        }
        body {
            margin: 0;
            display: table-cell;
            text-align: center;
            vertical-align: middle;
        }
    </style>
</head>

<body bgcolor="#DDA0DD">
    <img src="png/food_sweet_potato.png" width="32" height="32">
    <font size="5" color="#c71585">House of Murasaki-San</font>
    <img src="png/food_sweet_potato.png" width="32" height="32">
    <br>
    <font size="1" color="#c71585">(version 0.4.0a)</font><br>
    <br>
    <br>
    <font size="2"><a href="index5b.html?summoner=0">> Demo Preview Here <</a></font><br>
    <br>
    <font size="2">Summon your Murasaki-San</font><br>
    <font size="2">type:</font>
    <select name="class" id="ctype">
        <option value="1">1</option>
        <option value="2">2</option>
    </select>
    &nbsp;
    <input type="button" value=" Summon " onclick="contract_summon(1);" />
    <br>
    <br>
    <font size="2">Update your Murasaki-San</font><br>
    <form name="select_summoner">
        <input type="button" value=" Update => " onclick="button_update_summoners();" />
        &nbsp;
        <select name="select_summoner" id="summoner">
            <option value="***">***</option>
        </select>
        &nbsp;
        <input type="button" value=" Visit House " onclick="button_select_summoner();" />
    </form>
    <br>
    <br>
    <font size="2">Send Coin</font><br>
    <font size="2">From: </font><input type="number" id="coin_from">&nbsp;
        <font size="2">To: </font><input type="number" id="coin_to">&nbsp;
        <font size="2">Coin: </font><input type="number" id="coin_value">&nbsp;
        <input type="button" value="Send" onclick="button_send_coin();" />
    <br>
    <br>
    <font size="2">Send Material</font><br>
    <font size="2">From: </font><input type="number" id="material_from">&nbsp;
        <font size="2">To: </font><input type="number" id="material_to">&nbsp;
        <font size="2">Coin: </font><input type="number" id="material_value">&nbsp;
        <input type="button" value="Send" onclick="button_send_material();" />
    <br>
    <br>
    <font size="1" color="#000000)">Donation Address: 0x2F7448B62134e52C2f46454d0089Ae21B5248805</font>

<script type="text/javascript">

//global variants
//--------------------------------------------------------------------------------------------------------

let summoner = -1;



//web3
//--------------------------------------------------------------------------------------------------------

//connect to metamask
async function connect() {
    const web3 = await new Web3(window.ethereum);
    window.ethereum.enable();
    
    window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
            chainId: '0x51',  //4369
            //chainName: 'Shibuya Testnet',
            chainName: 'Local',
            nativeCurrency: {
                name: 'ASTL',
                symbol: 'ASTL',
                decimals: 18
            },
            //rpcUrls: ["https://rpc.shibuya.astar.network:8545"],
            rpcUrls: ["http://153.121.47.127:9933"],
            blockExplorerUrls: ['https://blockscout.com/shibuya'],
        }]
    });
    return web3;
}

//get wallet
async function get_wallet(web3) {
    const wallet = await web3.eth.getAccounts();
    return wallet[0];
}

//prepare contract, need abi_contract.js
async function get_contract(web3) {
    const contract = await new web3.eth.Contract(abi_murasaki_main, contract_address_murasaki_main);
    return contract;
}

//summon
async function contract_summon() {
    let ctype = document.getElementById("ctype").value
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    let price = 0.1 * 10**18;
    //let price = 0;
    contract.methods.summon(ctype).send({from:wallet, value:price});
}

//get owned summoners
async function contract_my_summoners() {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    let next_summoner = await contract.methods.next_summoner().call();
    let res = [];
    for (let i = 0; i < next_summoner; i++) {
        let owner = await contract.methods.ownerOf(i).call();
        if (owner == wallet) {
            res.push({text:i, value:i});
        }
    }
    console.log(res);
    return res;
}

//update select list
function _create_dropdownlist( form_name, select_name, select_array ){
	document[form_name][select_name].length = select_array.length;
	var i;
	for ( i=0; i<select_array.length; i++){
		document[form_name][select_name].options[i].text = select_array[i].text;
		document[form_name][select_name].options[i].value = select_array[i].value;
	}
}

//update summoner list
async function button_update_summoners() {
    opt_array = await contract_my_summoners();
    _create_dropdownlist("select_summoner","select_summoner", opt_array )
}

//update summoner
function button_select_summoner() {
    summoner = document.getElementById("summoner").value;
    window.location.href = "index4c.html?summoner=" + summoner;
}

//send coin
async function button_send_coin() {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    let coin_from = document.getElementById("coin_from").value;
    let coin_to = document.getElementById("coin_to").value;
    let coin_value = document.getElementById("coin_value").value;
    //console.log(element);
    contract.methods.transfer_coin(coin_from, coin_to, coin_value).send({from:wallet});
}

//send material
async function button_send_material() {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    let coin_from = document.getElementById("material_from").value;
    let coin_to = document.getElementById("material_to").value;
    let coin_value = document.getElementById("material_value").value;
    //console.log(element);
    contract.methods.transfer_material(coin_from, coin_to, coin_value).send({from:wallet});
}


</script>



</body>
</html>
