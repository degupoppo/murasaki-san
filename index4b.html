
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="png" href="png/icon.PNG">
    <title>House of Murasaki-San</title>
    <script src="phaser.js"></script>
    <script src="web3.min.js"></script>
    <script src="murasaki_main.js"></script>
    <script src="murasaki_craft.js"></script>
    <script src="murasaki_pet.js"></script>
    <script src="dropdownlist.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>


<!---

picture
    背景
ok! クリックアイコン（grooming, mining, farming, crafting）
    クリックアイコン（crafting）
    クリックアイコン（level-up）
ok! しゅっきん！（お仕事へ移動中）
    ごきげん！（お腹いっぱい＆ハッピーなときなど）
    おなかへった・・・
    ものづくりちゅう！（クラフト中）
    ありがとう！（ご飯たべたあとなど）
    クラフトアイテムたくさん（飼い主手伝う）
    成功したよー！（クラフト成功時, mining終了時など）
    失敗しちゃった・・・（クラフト失敗時など）
    れべるあっぷ！
    おんがくかんしょうちゅう～♪
    マイニングアイテム案（STR系）
        良いスコップ
        石像
    ファーミングアイテム案（DEX系）
        良いじょうろ
    クラフティングアイテム案（INT系）
        携帯電話
        ミュージックボックス

ToDo

    craftingのUI実装
     ok item_idの選択方法
     ok craftのstart/stopボタン
        選択アイテムのコスト表示
        成功/失敗の表現

    coin/material送金UIの実装
        

    petのUI実装
     ok pet所持の有無を監視
        petの絵の用意
        pet関数の実装
            moving
            resting
            mining
            farming
            moving_working
        petへのstart mining/farmingとstopの実装

    BGMと効果音の追加
     ok BGMのON/OFFボタンの実装
        効果音の実装
     ok クラフト可能なミュージックボックスの実装

    ステータス表示の実装
        数値＋視覚情報
     ok STR, DEX等のメーターをどうするか
            レーダーチャート？
                三角形のレーダーチャート + Luck表記
        coin, materialの表記をどうするか

    summoner所持item
        所持itemの検索
        所持itemのスプライト表示

    資源のバランスと差別化
        coinとmaterialの差別化

    色を変える
        phaser3での色彩変化
        もしくは手動での色彩変化済み画像の用意
        あるいは、ユニークな色のアクセサリー


--->

<script type="text/javascript">



// global variants
//--------------------------------------------------------------------------------------------------------

const version = "0.0.14";
let turn = 0;

let local_ctype;
let local_strength;
let local_dexterity;
//let local_vitality;
let local_intelligence;
let local_luck;
let local_birth_time;
let local_level = 1;
let local_last_feeding_time;
let local_last_grooming_time;
let local_coin;
let local_exp;
let local_mining_status;
let local_mining_start_time;
let local_next_exp_required;
let local_material;
let local_farming_status;
let local_farming_start_time;
let local_crafting_status;
let local_crafting_start_time;
let previous_local_last_feeding_time;
let previous_local_last_grooming_time;
let previous_local_level;
let summoner = -1;
let satiety;
let happy;
let local_coin_calc;
let local_material_calc;
let local_crafting_calc;
let local_pet;
let local_pet_mining_status;
let local_pet_mining_start_time;
let local_pet_coin_calc;
let local_pet_farming_status;
let local_pet_farming_start_time;
let local_pet_material_calc;
let local_musicbox;

let flag_pet = 0;       //0:not crafted, 1:crafted
let flag_music = 0;
let flag_musicbox = 0;

let previous_local_mining_status;
let previous_local_farming_status;
let previous_local_crafting_status;

let bgm = 0;


// html
//--------------------------------------------------------------------------------------------------------

//get summoner from url parameter
//https://www.tam-tam.co.jp/tipsnote/javascript/post9911.html
var urlParam = location.search.substring(1);
if(urlParam) {
    var param = urlParam.split('&');
    var paramArray = [];
    for (i = 0; i < param.length; i++) {
        var paramItem = param[i].split('=');
        paramArray[paramItem[0]] = paramItem[1];
    }
    summoner = paramArray.summoner
}



// web3
//--------------------------------------------------------------------------------------------------------

//connect to metamask
async function connect() {
    const web3 = await new Web3(window.ethereum);
    window.ethereum.enable();
    window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
            chainId: '0x51',  //4369
            chainName: 'Shibuya Testnet',
            nativeCurrency: {
                name: 'sby',
                symbol: 'SBY',
                decimals: 18
            },
            rpcUrls: ["https://rpc.shibuya.astar.network:8545"],
            blockExplorerUrls: ['https://blockscout.com/shibuya'],
        }]
    });
    return web3;
}

//get wallet
async function get_wallet(web3) {
    const wallet = await web3.eth.getAccounts();
    return wallet[0];
}

//prepare contract, need abi_contract.js
async function get_contract(web3) {
    const contract = await new web3.eth.Contract(abi_murasaki_main, contract_address_murasaki_main);
    return contract;
}

//prepare contract, pet
async function get_contract_pet(web3) {
    const contract = await new web3.eth.Contract(abi_murasaki_pet, contract_address_murasaki_pet);
    return contract;
}

//update local status reading from contract
async function contract_update_status(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let res = await contract.methods.get_status(summoner).call();
    console.log(res);   
    local_ctype = res[0];
    local_strength = res[1] /100;
    local_dexterity = res[2] /100;
    //local_vitality = res[3] /100;
    local_intelligence = res[4] /100;
    local_luck = res[5] /100;
    local_birth_time = res[6];
    local_last_feeding_time = res[7];
    local_last_grooming_time = res[8];
    local_coin = res[9];
    local_material = res[10];
    local_mining_status = res[11];
    local_mining_start_time = res[12];
    local_farming_status = res[13];
    local_farming_start_time = res[14];
    local_crafting_status = res[15];
    local_crafting_start_time = res[16];
    local_exp = res[17];
    local_level = res[18];
    local_next_exp_required = res[19];
    //progression status
    if (local_mining_status == 1){
        local_coin_calc = await contract.methods.calc_coin(summoner).call();
    }else if (local_farming_status == 1) {
        local_material_calc = await contract.methods.calc_material(summoner).call();
    }else if (local_crafting_status == 1) {
        local_crafting_calc = await contract.methods.calc_crafting(summoner).call();
    }
    //pet check
    //TODO: call whole items list, then view at type 49
    local_pet = await contract.methods.items(summoner, 49).call();
    if (local_pet != 0) {
        /* NEED to update contract!
        let contract_pet = await get_contract_pet(web3);
        res = await contract_pet.methods.get_status(summoner).call();
        local_pet_mining_status = res[0];
        local_pet_mining_start_time = res[1];
        local_pet_farming_status = res[2];
        local_pet_farming_start_time = res[3];
        */
    }
    local_musicbox = await contract.methods.items(summoner, 50).call();
}

//send feeding
async function contract_feeding(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    contract.methods.feeding(summoner).send({from:wallet});
}

//send grooming
async function contract_grooming(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    contract.methods.grooming(summoner).send({from:wallet});
}

//send level_up
async function contract_level_up(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    contract.methods.level_up(summoner).send({from:wallet});
}

//summon
async function contract_summon(ctype) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    contract.methods.summon(ctype).send({from:wallet});
}

//mining
async function contract_start_mining(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    if (local_mining_status == 0) {
        contract.methods.start_mining(summoner).send({from:wallet});
    }else {
        contract.methods.stop_mining(summoner).send({from:wallet});
    }
}
/*
async function contract_stop_mining(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    contract.methods.stop_mining(summoner).send({from:wallet});
}
*/

//farming
async function contract_start_farming(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    if (local_farming_status == 0) {
        contract.methods.start_farming(summoner).send({from:wallet});
    }else {
        contract.methods.stop_farming(summoner).send({from:wallet});
    }
}
/*
async function contract_stop_farming(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    contract.methods.stop_farming(summoner).send({from:wallet});
}
*/

//crafting
async function contract_start_crafting(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    //get item type from dropdown list
    let item_text = craft_item_list.text;
    let item_type = 0;
    if (item_text == "Ms. Astar (100/10)") {
        item_type = 49;
    }else if (item_text == "Music Box (100/10)") {
        item_type = 50;
    }else {
        item_type = 1;
    }
    if (local_crafting_status == 0) {
        console.log(item_type);
        contract.methods.start_crafting(summoner, item_type).send({from:wallet});
    } else{
        contract.methods.stop_crafting(summoner).send({from:wallet});
    }
}
/*
async function contract_stop_crafting(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    contract.methods.stop_crafting(summoner).send({from:wallet});
}
*/

//get items
async function contract_get_items(summoner) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    let items = await contract.methods.items(summoner,49).call();
    console.log(items);
}

//get item dcs
async function contract_get_item_dc(item_type) {
    let web3 = await connect();
    let contract = await get_contract(web3);
    let wallet = await get_wallet(web3);
    let item_dc = await contract.methods.get_item_dc(item_type).call();
    return item_dc;
}


// summoner
//--------------------------------------------------------------------------------------------------------
class Murasakisan extends Phaser.GameObjects.Sprite{
    constructor(scene, x, y){
        super(scene, x, y, "murasaki_right");
        this.scene.add.existing(this);
        this.anims.play("murasaki_right", true);
    	this.mode = "resting";
        this.submode = 0;
        this.count = 0;
        this.dist = "right";
        this.target_x = 0;
        this.target_y = 0;
        this.setInteractive()
        this.on("pointerdown", function (pointer) {
            this.on_click();
        }, this);
    }
    set set_mode(mode){
        this.mode = mode;
        this.count = 0;
    }
    get get_mode(){
        return this.mode;
    }
    on_click() {
        if (this.mode == "resting" || this.mode == "moving") {
            this.count = 0;
            this.mode = "hugging";
        }
    }
    resting(){
	    this.count += 1;
        if (this.count == 1) {
            if (this.dist == "right"){
                this.anims.play("murasaki_right", true);
            }else if (this.dist == "left") {
                this.anims.play("murasaki_left", true);
            }
            this.resting_count = 70 + Math.random() * 30;
	    }else if (this.count >= this.resting_count){
            let tmp = Math.random() * 100;
            if (tmp <= 10) {
                this.mode = "sleeping";
                this.count = 0;
            }else if (tmp <= 20 & happy <= 10) {
                this.mode = "crying";
                this.count = 0;
            }else {
                this.mode = "moving";
                this.count = 0;
            }
        }
    }
    moving() {
        this.count += 1;
        //determine direction
        if (this.count == 1){
            //determine degree, 0-30, 150-210, 330-360
            var li = [0,10,20,30,150,160,170,180,190,200,210,330,340,350]
            this.moving_degree = li[Math.floor(Math.random() * li.length)];
            //out of area check
            if (this.x < 100 && this.moving_degree > 90 && this.moving_degree <270) {
                this.moving_degree -= 180;
            }else if (this.x > 700 && (this.moving_degree < 90 || this.moving_degree > 270)) {
                this.moving_degree -= 180;
            }
            if (this.y > 500 && this.moving_degree > 180) {
                this.moving_degree = 360 - this.moving_degree;
            }else if (this.y < 300 && this.moving_degree < 180) {
                this.moving_degree = 360 - this.moving_degree;
            }
            //minus check
            if (this.moving_degree < 0) {
                this.moving_degree += 360;
            }
            //determine speed, count
            this.moving_speed = 0.3 + Math.random() * 0.2;  //0.3-0.5
            this.moving_count = 70 + Math.random() * 30;    //70-100
            //determine left or right
            if (this.moving_degree > 90 && this.moving_degree <= 270) {
                this.dist = "left";
                this.anims.play("murasaki_left", true);
            }else {
                this.dist = "right";
                this.anims.play("murasaki_right", true);
            }
            //debug
            //console.log(this.moving_degree, Math.sin(this.moving_degree * (Math.PI/180)), this.x, this.y);
        //moving
        }else if (this.count < this.moving_count) {
            this.x += Math.cos(this.moving_degree * (Math.PI/180)) * this.moving_speed;
            this.y -= Math.sin(this.moving_degree * (Math.PI/180)) * this.moving_speed;
        //return to resting
        }else if (this.count >= this.moving_count) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    //send: last_nutrition_time
    feeding() {
        this.count += 1;
        if (this.submode == 0) {
            //this.target_x = 600;
            //this.target_y = 400;
            let delta_x = this.target_x - this.x;
            if (delta_x >0) {
                this.dist = "right";
                this.anims.play("murasaki_feeding_happy_right", true);
            }else {
                this.dist = "left";
                this.anims.play("murasaki_feeding_happy_left", true);
            }
            this.submode = 1;
        }else if (this.submode == 1) {
            let delta_x = this.target_x - this.x;
            let delta_y = this.target_y - this.y;
            let delta_x2 = delta_x / (Math.abs(delta_x) + Math.abs(delta_y)) * 1.2;
            let delta_y2 = delta_y / (Math.abs(delta_x) + Math.abs(delta_y)) * 1.2;
            this.x += delta_x2;
            this.y += delta_y2;
            if (this.x > this.target_x-10 
              && this.x < this.target_x+10 
              && this.y > this.target_y-10 
              && this.y < this.target_y+10) {
                this.submode = 2;
            }
        }else if (this.submode == 2) {
            this.anims.play("murasaki_feeding", true);
            food.destroy();
            this.count_limit = this.count + 1000;
            this.submode = 3;
        }else if (this.submode == 3) {
            if (this.count >= this.count_limit) {
                this.mode = "resting";
                this.count = 0;
            }
        }
    }
    crying() {
        this.count += 1;
        if (this.count == 1){
            this.anims.play("murasaki_crying", true);
        }else if (this.count >= 500) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    sleeping() {
        this.count += 1;
        if (this.count == 1){
            this.anims.play("murasaki_sleeping", true);
        }else if (this.count >= 1000) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    //send: last_grooming_time
    grooming() {
        this.count += 1;
        if (this.submode == 0) {
            let delta_x = this.target_x - this.x;
            if (delta_x >0) {
                this.dist = "right";
                this.anims.play("murasaki_feeding_happy_right", true);
            }else {
                this.dist = "left";
                this.anims.play("murasaki_feeding_happy_left", true);
            }
            this.submode = 1;
        }else if (this.submode == 1) {
            let delta_x = this.target_x - this.x;
            let delta_y = this.target_y - this.y;
            let delta_x2 = delta_x / (Math.abs(delta_x) + Math.abs(delta_y)) * 1.2;
            let delta_y2 = delta_y / (Math.abs(delta_x) + Math.abs(delta_y)) * 1.2;
            this.x += delta_x2;
            this.y += delta_y2;
            if (this.x > this.target_x-10 
              && this.x < this.target_x+10 
              && this.y > this.target_y-10 
              && this.y < this.target_y+10) {
                this.submode = 2;
            }
        }else if (this.submode == 2) {
            this.x = this.target_x;
            this.y = this.target_y;
            this.anims.play("murasaki_grooming", true);
            this.count_limit = this.count + 1500;
            this.submode = 3;
        }else if (this.submode == 3) {
            if (this.count >= this.count_limit) {
                this.mode = "resting";
                this.count = 0;
            }
        }
    }
    //cost: life, gain: coin
    mining() {
        this.count += 1;
        if (this.submode == 0) {
            let delta_x = this.target_x - this.x;
            if (delta_x >0) {
                this.dist = "right";
                this.anims.play("murasaki_working_right", true);
            }else {
                this.dist = "left";
                this.anims.play("murasaki_working_left", true);
            }
            this.submode = 1;
        }else if (this.submode == 1) {
            let delta_x = this.target_x - this.x;
            let delta_y = this.target_y - this.y;
            let delta_x2 = delta_x / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            let delta_y2 = delta_y / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            this.x += delta_x2;
            this.y += delta_y2;
            if (this.x > this.target_x-10 
              && this.x < this.target_x+10 
              && this.y > this.target_y-10 
              && this.y < this.target_y+10) {
                this.submode = 2;
            }
        }else if (this.submode == 2) {
            this.anims.play("murasaki_mining", true);
        }
    }
    hugging() {
        this.count += 1;
        if (this.count == 1){
            this.anims.play("murasaki_click", true);
        }else if (this.count >= 250) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    farming() {
        this.count += 1;
        if (this.submode == 0) {
            let delta_x = this.target_x - this.x;
            if (delta_x >0) {
                this.dist = "right";
                this.anims.play("murasaki_working_right", true);
            }else {
                this.dist = "left";
                this.anims.play("murasaki_working_left", true);
            }
            this.submode = 1;
        }else if (this.submode == 1) {
            let delta_x = this.target_x - this.x;
            let delta_y = this.target_y - this.y;
            let delta_x2 = delta_x / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            let delta_y2 = delta_y / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            this.x += delta_x2;
            this.y += delta_y2;
            if (this.x > this.target_x-10 
              && this.x < this.target_x+10 
              && this.y > this.target_y-10 
              && this.y < this.target_y+10) {
                this.submode = 2;
            }
        }else if (this.submode == 2) {
            this.anims.play("murasaki_farming", true);
        }
    }
    crafting() {
        this.count += 1;
        if (this.submode == 0) {
            let delta_x = this.target_x - this.x;
            if (delta_x >0) {
                this.dist = "right";
                this.anims.play("murasaki_working_right", true);
            }else {
                this.dist = "left";
                this.anims.play("murasaki_working_left", true);
            }
            this.submode = 1;
        }else if (this.submode == 1) {
            let delta_x = this.target_x - this.x;
            let delta_y = this.target_y - this.y;
            let delta_x2 = delta_x / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            let delta_y2 = delta_y / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            this.x += delta_x2;
            this.y += delta_y2;
            if (this.x > this.target_x-10 
              && this.x < this.target_x+10 
              && this.y > this.target_y-10 
              && this.y < this.target_y+10) {
                this.submode = 2;
            }
        }else if (this.submode == 2) {
            this.anims.play("murasaki_farming", true);
        }
    }
    update(){
        //console.log(this.version, this.mode, this.count);
        if (this.mode == "resting") {this.resting();}
        else if (this.mode == "moving") {this.moving();}
        else if (this.mode == "feeding") {this.feeding();}
        else if (this.mode == "crying") {this.crying();}
        else if (this.mode == "sleeping") {this.sleeping();}
        else if (this.mode == "grooming") {this.grooming();}
        else if (this.mode == "mining") {this.mining();}
        else if (this.mode == "hugging") {this.hugging();}
        else if (this.mode == "farming") {this.farming();}
        else if (this.mode == "crafting") {this.farming();}
    }
}



//pet
//--------------------------------------------------------------------------------------------------------

class Pet extends Phaser.GameObjects.Sprite{
    constructor(scene, x, y){
        super(scene, x, y, "pet_normal");
        this.scene.add.existing(this);
        this.anims.play("pet_normal", true);
    	this.mode = "resting";
        this.submode = 0;
        this.count = 0;
        this.dist = "right";
        this.target_x = 0;
        this.target_y = 0;
        this.setInteractive()
        this.on("pointerdown", function (pointer) {
            this.on_click();
        }, this);
    }
    set set_mode(mode){
        this.mode = mode;
        this.count = 0;
    }
    get get_mode(){
        return this.mode;
    }
    on_click() {
        /***
        if (this.mode == "resting" || this.mode == "moving") {
            this.count = 0;
            this.mode = "hugging";
        }
        ***/
    }
    resting(){
	    this.count += 1;
        if (this.count == 1) {
            if (this.dist == "right"){
                this.anims.play("pet_normal", true);
            }else if (this.dist == "left") {
                this.anims.play("pet_normal", true);
            }
            this.resting_count = 100 + Math.random() * 30;
	    }else if (this.count >= this.resting_count){
            let tmp = Math.random() * 100;
            this.mode = "moving";
            this.count = 0;
            /***
            if (tmp <= 10) {
                this.mode = "sleeping";
                this.count = 0;
            }else if (tmp <= 20 & happy <= 10) {
                this.mode = "crying";
                this.count = 0;
            }else {
                this.mode = "moving";
                this.count = 0;
            }
            ***/
        }
    }
    moving() {
        this.count += 1;
        //determine direction
        if (this.count == 1){
            //determine degree, 0-30, 150-210, 330-360
            var li = [0,10,20,30,150,160,170,180,190,200,210,330,340,350]
            this.moving_degree = li[Math.floor(Math.random() * li.length)];
            //out of area check
            if (this.x < 100 && this.moving_degree > 90 && this.moving_degree <270) {
                this.moving_degree -= 180;
            }else if (this.x > 700 && (this.moving_degree < 90 || this.moving_degree > 270)) {
                this.moving_degree -= 180;
            }
            if (this.y > 500 && this.moving_degree > 180) {
                this.moving_degree = 360 - this.moving_degree;
            }else if (this.y < 300 && this.moving_degree < 180) {
                this.moving_degree = 360 - this.moving_degree;
            }
            //minus check
            if (this.moving_degree < 0) {
                this.moving_degree += 360;
            }
            //determine speed, count
            this.moving_speed = 0.2 + Math.random() * 0.1;  //0.3-0.5
            this.moving_count = 70 + Math.random() * 30;    //70-100
            //determine left or right
            if (this.moving_degree > 90 && this.moving_degree <= 270) {
                this.dist = "left";
                this.anims.play("pet_normal", true);
            }else {
                this.dist = "right";
                this.anims.play("pet_normal", true);
            }
        //moving
        }else if (this.count < this.moving_count) {
            this.x += Math.cos(this.moving_degree * (Math.PI/180)) * this.moving_speed;
            this.y -= Math.sin(this.moving_degree * (Math.PI/180)) * this.moving_speed;
        //return to resting
        }else if (this.count >= this.moving_count) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    sleeping() {
        this.count += 1;
        if (this.count == 1){
            this.anims.play("murasaki_sleeping", true);
        }else if (this.count >= 1000) {
            this.mode = "resting";
            this.count = 0;
        }
    }
    //cost: life, gain: coin
    mining() {
        this.count += 1;
        if (this.submode == 0) {
            let delta_x = this.target_x - this.x;
            if (delta_x >0) {
                this.dist = "right";
                this.anims.play("murasaki_working_right", true);
            }else {
                this.dist = "left";
                this.anims.play("murasaki_working_left", true);
            }
            this.submode = 1;
        }else if (this.submode == 1) {
            let delta_x = this.target_x - this.x;
            let delta_y = this.target_y - this.y;
            let delta_x2 = delta_x / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            let delta_y2 = delta_y / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            this.x += delta_x2;
            this.y += delta_y2;
            if (this.x > this.target_x-10 
              && this.x < this.target_x+10 
              && this.y > this.target_y-10 
              && this.y < this.target_y+10) {
                this.submode = 2;
            }
        }else if (this.submode == 2) {
            this.anims.play("murasaki_mining", true);
        }
    }
    farming() {
        this.count += 1;
        if (this.submode == 0) {
            let delta_x = this.target_x - this.x;
            if (delta_x >0) {
                this.dist = "right";
                this.anims.play("murasaki_working_right", true);
            }else {
                this.dist = "left";
                this.anims.play("murasaki_working_left", true);
            }
            this.submode = 1;
        }else if (this.submode == 1) {
            let delta_x = this.target_x - this.x;
            let delta_y = this.target_y - this.y;
            let delta_x2 = delta_x / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            let delta_y2 = delta_y / (Math.abs(delta_x) + Math.abs(delta_y)) * 0.8;
            this.x += delta_x2;
            this.y += delta_y2;
            if (this.x > this.target_x-10 
              && this.x < this.target_x+10 
              && this.y > this.target_y-10 
              && this.y < this.target_y+10) {
                this.submode = 2;
            }
        }else if (this.submode == 2) {
            this.anims.play("murasaki_farming", true);
        }
    }
    update(){
        //console.log(this.version, this.mode, this.count);
        if (this.mode == "resting") {this.resting();}
        else if (this.mode == "moving") {this.moving();}
        else if (this.mode == "sleeping") {this.sleeping();}
        else if (this.mode == "mining") {this.mining();}
        else if (this.mode == "farming") {this.farming();}
    }
}



//accessories
//--------------------------------------------------------------------------------------------------------

//bar
function makeBar(scene, x, y, color) {
    //draw the bar
    let bar = scene.add.graphics();
    //color the bar
    bar.fillStyle(color, 1);
    //fill the bar with a rectangle
    bar.fillRect(0, 0, 100, 10);
    //position the bar
    bar.x = x;
    bar.y = y;
    //return the bar
    return bar;
}

//button
//TODO: send transaction
class Button {
    constructor(x, y, label, scene, callback) {
        let fontsize = 18;
        const button = scene.add.text(x, y, label)
            .setFontSize(fontsize)
            .setFontFamily("Arial")
            .setFill("#000000")
            //.setOrigin(0.5)
            //.setPadding(10)
            //.setStyle({ backgroundColor: '#111' })
            .setInteractive({ useHandCursor: true })
            .on('pointerdown', () => callback())
            .on('pointerover', () => button.setStyle({ fontSize: fontsize, fontFamily: "Arial", fill: '#ffff00' }))
            .on('pointerout', () => button.setStyle({ fontSize: fontsize, fontFamily: "Arial", fill: '#000000' }));
    }
}

//music
function music() {
    if (flag_music == 0) {
        if (bgm == bgm1) {
            bgm = bgm2;
        }else if (bgm == bgm2) {
            bgm = bgm3;
        }else {
            bgm = bgm1;
        }
        //let array = [bgm1, bgm2, bgm3];
        //bgm = array[Math.floor(Math.random() * array.length)];
        bgm.play();
        flag_music = 1;
    }else {
        bgm.stop();
        flag_music = 0;
    }
}

//rader chart
function radarchart(scene, str, dex, int, luk) {
    //position
    let x0 = 730;
    let y0 = 70;
    let r = 50;
    //base
    let base = 20;
    //calc (x,y) from status
    let x1 = 0;
    let y1 = -r * str/base;
    let x2 = r * dex/base;
    let y2 = 0;
    let x3 = 0;
    let y3 = r * luk/base;
    let x4 = -r * int/base;
    let y4 = 0;
    //remove old chart
    try {
        radar1.setVisible(false);
        radar2.setVisible(false);
        radar3.setVisible(false);
        radar4.setVisible(false);
        radar5.setVisible(false);
        radar6.setVisible(false);
        radar7.setVisible(false);
        radar8.setVisible(false);
    } catch(error) {
    }
    //draw
    //scene.add.graphics().fillStyle(0xc0c0c0, 1).fillCircle(x0, y0, r, 0.5);
    radar1 = scene.add.polygon(x0+r, y0+r, [0,-r,r,0,0,r,-r,0], 0xc0c0c0, 0.4);
    radar2 = scene.add.polygon(x0+r*0.75, y0+r*0.75, [0,-r*0.75,r*0.75,0,0,r*0.75,-r*0.75,0], 0xc0c0c0, 0.6);
    radar3 = scene.add.polygon(x0+r/2, y0+r/2, [0,-r/2,r/2,0,0,r/2,-r/2,0], 0xc0c0c0, 0.8);
    radar4 = scene.add.polygon(x0+(-x4+x2)/2, y0+(-y1+y3)/2, [x1,y1,x2,y2,x3,y3,x4,y4], 0xffff00, 1);
    radar5 = scene.add.text(x0-10, y0-r-8, "STR", {font: "10.5px Arial", fill: "#000000"});
    radar6 = scene.add.text(x0+r, y0-6, "DEX", {font: "10.5px Arial", fill: "#000000"});
    radar7 = scene.add.text(x0-10, y0+r, "LUK", {font: "10.5px Arial", fill: "#000000"});
    radar8 = scene.add.text(x0-r-15, y0-6, "INT", {font: "10.5px Arial", fill: "#000000"});
}


// main functions
//--------------------------------------------------------------------------------------------------------


let config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    },
    render: {
        pixelArt: false
    },
    //resolution: 5,
};
let game = new Phaser.Game(config);



// preload
//--------------------------------------------------------------------------------------------------------
function preload() {

    //back
    this.load.image("back", "png/back.jpg");

    //murasakisan
    this.load.spritesheet("murasaki_right", "png/murasaki_right.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_left", "png/murasaki_left.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_sleeping", "png/murasaki_sleeping.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_feeding", "png/murasaki_feeding.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_feeding_happy_right", 
        "png/murasaki_feeding_happy_right.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_feeding_happy_left", 
        "png/murasaki_feeding_happy_left.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_crying", "png/murasaki_crying.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_mining", "png/murasaki_mining.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_hugging", "png/murasaki_hugging.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_farming", "png/murasaki_farming.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_grooming", "png/murasaki_grooming.png", {frameWidth: 720, frameHeight: 622});
    this.load.spritesheet("murasaki_working_left", "png/murasaki_working_left.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_working_right", "png/murasaki_working_right.png", {frameWidth: 370, frameHeight: 320});
    this.load.spritesheet("murasaki_click", "png/murasaki_click.png", {frameWidth: 370, frameHeight: 320});

    //button
    this.load.image("button_feeding", "png/button_feeding.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_feeding_pointerover", "png/button_feeding_pointerover.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("food_sweet_potato", "png/food_sweet_potato.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("item_bear", "png/item_bear.png", {frameWidth: 720, frameHeight: 622});
    this.load.spritesheet("pet_normal", "png/pet_normal.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_mining_enable", "png/button_mining_enable.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_mining_unable", "png/button_mining_unable.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_mining_pointerover", "png/button_mining_pointerover.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_mining_working", "png/button_mining_working.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_mining_pointerover_stop", "png/button_mining_pointerover_stop.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_farming_enable", "png/button_farming_enable.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_farming_unable", "png/button_farming_unable.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_farming_pointerover", "png/button_farming_pointerover.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_farming_working", "png/button_farming_working.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_farming_pointerover_stop", "png/button_farming_pointerover_stop.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_crafting_enable", "png/button_mining_enable.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_crafting_unable", "png/button_mining_unable.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_crafting_pointerover", "png/button_mining_pointerover.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_crafting_working", "png/button_mining_working.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_crafting_pointerover_stop", "png/button_mining_pointerover_stop.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_grooming_enable", "png/button_grooming_enable.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_grooming_unable", "png/button_grooming_unable.png", {frameWidth: 500, frameHeight: 500});
    this.load.image("button_grooming_pointerover", "png/button_grooming_pointerover.png", {frameWidth: 500, frameHeight: 500});

    //sound
    this.load.audio("bgm1", "mp3/Morning_2.mp3");
    this.load.audio("bgm2", "mp3/Roll_Roll_Roll.mp3");
    this.load.audio("bgm3", "mp3/boukenki.mp3");

    //dropdownlist
    //https://rexrainbow.github.io/phaser3-rex-notes/docs/site/ui-menu/
    this.load.scenePlugin({
        key: 'rexuiplugin',
        url: 'rexuiplugin.min.js',
        sceneKey: 'rexUI'
    });

    //items
    this.load.image("item_musicbox", "png/item_musicbox.png", {frameWidth: 300, frameHeight: 300});

}



// create
//--------------------------------------------------------------------------------------------------------
function create() {

    //back image
    this.add.image(400, 300, "back");

    //animations
    this.anims.create({
        key: "murasaki_right",
        frames: this.anims.generateFrameNumbers("murasaki_right", {start:0, end:3}),
        frameRate: 2,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_left",
        frames: this.anims.generateFrameNumbers("murasaki_left", {start:0, end:3}),
        frameRate: 2,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_sleeping",
        frames: this.anims.generateFrameNumbers("murasaki_sleeping", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_feeding",
        frames: this.anims.generateFrameNumbers("murasaki_feeding", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_feeding_happy_right",
        frames: this.anims.generateFrameNumbers("murasaki_feeding_happy_right", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_feeding_happy_left",
        frames: this.anims.generateFrameNumbers("murasaki_feeding_happy_left", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_crying",
        frames: this.anims.generateFrameNumbers("murasaki_crying", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_mining",
        frames: this.anims.generateFrameNumbers("murasaki_mining", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_hugging",
        frames: this.anims.generateFrameNumbers("murasaki_hugging", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_farming",
        frames: this.anims.generateFrameNumbers("murasaki_farming", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_grooming",
        frames: this.anims.generateFrameNumbers("murasaki_grooming", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_working_left",
        frames: this.anims.generateFrameNumbers("murasaki_working_left", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_working_right",
        frames: this.anims.generateFrameNumbers("murasaki_working_right", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "murasaki_click",
        frames: this.anims.generateFrameNumbers("murasaki_click", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    this.anims.create({
        key: "pet_normal",
        frames: this.anims.generateFrameNumbers("pet_normal", {start:0, end:1}),
        frameRate: 1,
        repeat: -1
    });
    
    //item_bear
    item_bear = this.add.sprite(300,250, "item_bear");
    item_bear.scaleX = item_bear.scaleX * 0.3;
    item_bear.scaleY = item_bear.scaleY * 0.3;

    //button_icon
    button_feeding = this.add.sprite(680,400, "button_feeding");
    button_feeding.scaleX = button_feeding.scaleX * 0.1;
    button_feeding.scaleY = button_feeding.scaleY * 0.1;
    button_feeding.setInteractive({useHandCursor: true});
    button_feeding.on('pointerdown', () => contract_feeding(summoner) );
    button_feeding.on('pointerover', () => button_feeding.setTexture("button_feeding_pointerover"));
    button_feeding.on('pointerout', () => button_feeding.setTexture("button_feeding"));

    button_grooming = this.add.sprite(350,130, "button_grooming_unable");
    button_grooming.scaleX = button_grooming.scaleX * 0.1;
    button_grooming.scaleY = button_grooming.scaleY * 0.1;
    button_grooming.setInteractive({useHandCursor: true});
    button_grooming.on('pointerdown', () => contract_grooming(summoner) );
    button_grooming.on('pointerover', () => button_grooming.setTexture("button_grooming_pointerover"));
    button_grooming.on('pointerout', () => button_grooming.setTexture("button_grooming"));
    button_grooming.disableInteractive();

    button_crafting = this.add.sprite(500,130, "button_crafting_unable");
    button_crafting.scaleX = button_crafting.scaleX * 0.1;
    button_crafting.scaleY = button_crafting.scaleY * 0.1;
    button_crafting.setInteractive({useHandCursor: true});
    button_crafting.on('pointerdown', () => contract_start_crafting(summoner) );
    button_crafting.on('pointerover', () => button_crafting.setTexture("button_crafting_pointerover"));
    button_crafting.on('pointerout', () => button_crafting.setTexture("button_crafting_enable"));
    button_crafting.disableInteractive();

    button_mining = this.add.sprite(40,360, "button_mining_unable");
    button_mining.scaleX = button_mining.scaleX * 0.1;
    button_mining.scaleY = button_mining.scaleY * 0.1;
    button_mining.setInteractive({useHandCursor: true});
    button_mining.on('pointerdown', () => contract_start_mining(summoner) );
    button_mining.on('pointerover', () => button_mining.setTexture("button_mining_pointerover"));
    button_mining.on('pointerout', () => button_mining.setTexture("button_mining_enable"));
    button_mining.disableInteractive();

    button_farming = this.add.sprite(40,220, "button_farming_unable");
    button_farming.scaleX = button_farming.scaleX * 0.1;
    button_farming.scaleY = button_farming.scaleY * 0.1;
    button_farming.setInteractive({useHandCursor: true});
    button_farming.on('pointerdown', () => contract_start_farming(summoner) );
    button_farming.on('pointerover', () => button_farming.setTexture("button_farming_pointerover"));
    button_farming.on('pointerout', () => button_farming.setTexture("button_farming_enable"));
    button_farming.disableInteractive();

    //bgm
    bgm1 = this.sound.add("bgm1", {volume:0.3, loop:true});
    bgm2 = this.sound.add("bgm2", {volume:0.3, loop:true});
    bgm3 = this.sound.add("bgm3", {volume:0.3, loop:true});

    //summoner
    murasakisan = new Murasakisan(this, 300 + Math.random()*200, 400 + Math.random()*100);
    murasakisan.scaleX = murasakisan.scaleX * 0.3;
    murasakisan.scaleY = murasakisan.scaleY * 0.3;

    //button_text
    new Button(30, 10, 'Level Up', this, () => contract_level_up(summoner));

    //status window color fill
    let status_back = this.add.graphics();
    status_back.fillStyle(0xa9a9a9, 1).fillRect(590, 5, 200, 300);
    status_back.alpha = 0.4;

    //status window
    let font_arg = {font: "10.5px Arial", fill: "#000"};
    text_summoner =     this.add.text(600,  10, "Summoner: " + summoner, font_arg);
    text_type =         this.add.text(600,  20, "Type: " + local_ctype, font_arg);
    text_level =        this.add.text(600,  40, "  Lv: " + local_level, font_arg);
    text_strength =     this.add.text(600,  50, " STR: " + local_strength, font_arg);
    text_dexterity =    this.add.text(600,  60, " DEX: " + local_dexterity, font_arg);
    text_intelligence = this.add.text(600,  70, " INT = " + local_intelligence, font_arg);
    text_luck =         this.add.text(600,  80, " LUK: " + local_luck, font_arg);
    text_exp =          this.add.text(600, 100, " EXP: " + local_exp, font_arg);
    text_turn =         this.add.text(600, 120, "turn = ", font_arg);
    text_age_time =     this.add.text(600, 130, " age = ", font_arg);
    text_mode =         this.add.text(600, 140, "mode = ", font_arg);

    //bar
    //satiety
    this.add.text(600, 160, "Satiety:", font_arg);
    bar_satiety_back = makeBar(this, 640, 160, 0xa9a9a9);
    bar_satiety_back.scaleX = 1;
    bar_satiety = makeBar(this, 640, 160, 0xff4500);
    bar_satiety.scaleX = 0;
    //happy
    this.add.text(600, 180, "Happy:", font_arg);
    bar_happy_back = makeBar(this, 640, 180, 0xa9a9a9);
    bar_happy_back.scaleX = 1;
    bar_happy = makeBar(this, 640, 180, 0x4169e1);
    bar_happy.scaleX = 0;
    //exp
    this.add.text(600, 200, "EXP:", font_arg);
    bar_exp_back = makeBar(this, 640, 200, 0xa9a9a9);
    bar_exp_back.scaleX = 1;
    bar_exp = makeBar(this, 640, 200, 0x228b22);
    bar_exp.scaleX = 0;
    //coin
    text_coin = this.add.text(
        600, 220, "Coin: " + local_coin, font_arg);
    text_material = this.add.text(
        600, 230, "Material: " + local_material, font_arg);

    //progression
    text_working_calc = this.add.text(600, 260, "***", {font: "14px Arial", fill: "#000"});

    //pet
    text_pet = this.add.text(600, 280, "***", font_arg);

    //craft item dropdown list
    let options = [
        " > SELECT ITEM < ",
        "Ms. Astar (100/10)",
        "Music Box (100/10)"
    ];
    craft_item_list = CreateDropDownList(this, 500, 65, options)
        .layout()
    text_craft_item = this.add.text(200, 200, "", font_arg);

}



// update
//--------------------------------------------------------------------------------------------------------
function update() {

    if (summoner == -1) {
        return 0;
    }

    //increment turn
    turn += 1;
    text_turn.setText("turn = " + turn);

    //update character
    murasakisan.update();
    if (flag_pet == 1) {
        pet.update();
    }

    //update calculation status
    if (turn % 100 == 0) {

        //level up
        if (local_level > previous_local_level) {
        }else 

        //feeding check
        if (local_last_feeding_time > previous_local_last_feeding_time){
            murasakisan.set_mode = "feeding";
            murasakisan.submode = 0;
            murasakisan.count = 0;
            murasakisan.target_x = 600;
            murasakisan.target_y = 400;
            if (typeof food !== "undefined") {
                food.destroy();
                //food.visible = false;
            }
            food = this.add.sprite(600,400, "food_sweet_potato");
            food.scaleX = food.scaleX * 0.1;
            food.scaleY = food.scaleY * 0.1;
        }else

        //grooming check
        if (local_last_grooming_time > previous_local_last_grooming_time){
            murasakisan.set_mode = "grooming";
            murasakisan.submode = 0;
            murasakisan.count = 0;
            murasakisan.target_x = 300;
            murasakisan.target_y = 250;
        }

        //mining check
        if (local_mining_status == 1 & murasakisan.mode != "mining" & murasakisan.mode != "feeding"){
            murasakisan.set_mode = "mining";
            murasakisan.submode = 0;
            murasakisan.count = 0;
            murasakisan.target_x = 70;
            murasakisan.target_y = 420;
        }else if (local_mining_status == 0 & murasakisan.mode == "mining") {
            murasakisan.set_mode = "resting";
        }else

        //farming check
        if (local_farming_status == 1 & murasakisan.mode != "farming" & murasakisan.mode != "feeding"){
            murasakisan.set_mode = "farming";
            murasakisan.submode = 0;
            murasakisan.count = 0;
            murasakisan.target_x = 150;
            murasakisan.target_y = 260;
        }else if (local_farming_status == 0 & murasakisan.mode == "farming") {
            murasakisan.set_mode = "resting";
        }else 

        //crafting check
        if (local_crafting_status == 1 & murasakisan.mode != "crafting" & murasakisan.mode != "feeding"){
            murasakisan.set_mode = "crafting";
            murasakisan.submode = 0;
            murasakisan.count = 0;
            murasakisan.target_x = 500;
            murasakisan.target_y = 250;
        }else if (local_crafting_status == 0 & murasakisan.mode == "crafting") {
            murasakisan.set_mode = "resting";
        }

        //update calculation_status
        let now_time = Date.now() / 1000;
        let age_time = Math.round(now_time - local_birth_time);
        let mode = murasakisan.get_mode;
        let base = 86400 /10;
        //satiety
        satiety = Math.round( (base - (now_time - local_last_feeding_time)) / base * 100 );
        if (satiety < 0) { satiety = 0; }
        if (satiety > 100) { satiety = 100; }
        let base2 = 86400 * 3 /10;
        //happy
        happy = Math.round( (base2 - (now_time - local_last_grooming_time)) / base2 * 100 );
        if (happy < 0) { happy = 0; }
        if (happy > 100) { happy = 100; }
        //exp
        let exp = (local_exp / local_next_exp_required) * 100;
        if (exp > 100) { exp = 100; }

        //update text
        text_summoner.setText   ("summoner = " + summoner);
        text_type.setText       ("type = " + local_ctype);
        //status
        text_level.setText          (" Lv: " + local_level);
        text_strength.setText       ("STR: " + local_strength);
        text_dexterity.setText      ("DEX: " + local_dexterity);
        //text_vitality.setText       ("VIT: " + local_vitality);
        text_intelligence.setText   ("INT: " + local_intelligence);
        text_luck.setText           ("LUK: " + local_luck);
        text_exp.setText            ("EXP: " + local_exp);
        //game info
        text_turn.setText       ("turn = " + turn);
        text_age_time.setText   ("age = " + age_time);
        text_mode.setText       ("mode = " + mode);
        //coin & material
        text_coin.setText("coin = " + local_coin);
        text_material.setText("material = " + local_material);

        //update bar
        bar_satiety.scaleX = satiety / 100;
        bar_happy.scaleX = happy / 100;
        bar_exp.scaleX = exp / 100;

        //update progression status
        if (mode == "mining") {
            text_working_calc.setText("+ " + local_coin_calc + " coin");
        }else if (mode == "farming") {
            text_working_calc.setText("+ " + local_material_calc + " material");
        }else if (mode == "crafting") {
            if (local_crafting_calc > 0) {
                text_working_calc.setText(local_crafting_calc + " sec left");
            } else{
                text_working_calc.setText("Completed!");
            }
        }else {
            text_working_calc.setText("");
        }

        //pet
        if (local_pet > 0) {
            text_pet.setText("pet_id = " + local_pet);
            if (flag_pet == 0) {
                pet = new Pet(this, 300 + Math.random()*200, 400 + Math.random()*100);
                pet.scaleX = pet.scaleX * 0.1;
                pet.scaleY = pet.scaleY * 0.1;
                flag_pet = 1;
            }
        } else{
            text_pet.setText("pet_id = not yet crafted");
        }

        //musicbox
        if (local_musicbox > 0) {
            if (flag_musicbox == 0) {
                item_musicbox = this.add.sprite(750,550, "item_musicbox");
                item_musicbox.scaleX = item_musicbox.scaleX * 0.2;
                item_musicbox.scaleY = item_musicbox.scaleY * 0.2;
                item_musicbox.setInteractive({useHandCursor: true});
                item_musicbox.on('pointerdown', () => music() );
                flag_musicbox = 1;
            }
        }
        
        previous_local_last_feeding_time = local_last_feeding_time;
        previous_local_last_grooming_time = local_last_grooming_time;
        previous_local_level = local_level;
    }

    //flag management & button activation
    if (turn % 250 == 0) {

        if (
            previous_local_mining_status != local_mining_status ||
            previous_local_farming_status != local_farming_status ||
            previous_local_crafting_status != local_crafting_status
            ) {

            //grooming
            if (local_farming_status == 1 || local_crafting_status == 1 || local_mining_status == 1) {
                button_grooming.setTexture("button_grooming_unable");
                button_grooming.disableInteractive();
            }else {
                button_grooming.setTexture("button_grooming_enable");
                button_grooming.on('pointerover', () => button_grooming.setTexture("button_grooming_pointerover"));
                button_grooming.on('pointerout', () => button_grooming.setTexture("button_grooming_enable"));
                button_grooming.setInteractive();
            }

            //mining
            if (local_farming_status == 1 || local_crafting_status == 1 || local_level <= 1) {
                button_mining.setTexture("button_mining_unable");
                button_mining.disableInteractive();
            }else if (local_mining_status == 1) {
                button_mining.setTexture("button_mining_working");
                button_mining.on('pointerover', () => button_mining.setTexture("button_mining_pointerover_stop"));
                button_mining.on('pointerout', () => button_mining.setTexture("button_mining_working"));
                button_mining.setInteractive();
                text_working_calc.x = 70;
                text_working_calc.y = 340;
            }else {
                button_mining.setTexture("button_mining_enable");
                button_mining.on('pointerover', () => button_mining.setTexture("button_mining_pointerover"));
                button_mining.on('pointerout', () => button_mining.setTexture("button_mining_enable"));
                button_mining.setInteractive();
            }

            //farming
            if (local_mining_status == 1 || local_crafting_status == 1 || local_level <= 1) {
                button_farming.setTexture("button_farming_unable");
                button_farming.disableInteractive();
            }else if (local_farming_status == 1) {
                button_farming.setTexture("button_farming_working");
                button_farming.on('pointerover', () => button_farming.setTexture("button_farming_pointerover_stop"));
                button_farming.on('pointerout', () => button_farming.setTexture("button_farming_working"));
                button_farming.setInteractive();
                text_working_calc.x = 70;
                text_working_calc.y = 210;
            }else {
                button_farming.setTexture("button_farming_enable");
                button_farming.on('pointerover', () => button_farming.setTexture("button_farming_pointerover"));
                button_farming.on('pointerout', () => button_farming.setTexture("button_farming_enable"));
                button_farming.setInteractive();
            }

            //crafting
            if (local_mining_status == 1 || local_farming_status == 1 || local_level <= 2) {
                button_crafting.setTexture("button_crafting_unable");
                button_crafting.disableInteractive();
            }else if (local_crafting_status == 1) {
                button_crafting.setTexture("button_crafting_working");
                button_crafting.on('pointerover', () => button_crafting.setTexture("button_crafting_pointerover_stop"));
                button_crafting.on('pointerout', () => button_crafting.setTexture("button_crafting_working"));
                button_crafting.setInteractive();
                text_working_calc.x = 470;
                text_working_calc.y = 80;
            }else {
                button_crafting.setTexture("button_crafting_enable");
                button_crafting.on('pointerover', () => button_crafting.setTexture("button_crafting_pointerover"));
                button_crafting.on('pointerout', () => button_crafting.setTexture("button_crafting_enable"));
                button_crafting.setInteractive();
            }

            //update radarchart
            radarchart(this, local_strength, local_dexterity, local_intelligence, local_luck);

        }

        previous_local_mining_status = local_mining_status;
        previous_local_farming_status = local_farming_status;
        previous_local_crafting_status = local_crafting_status;

    }

    //update dynamic status from contract to local
    if (turn % 201 == 0) {
        //update dynamic_status
        //summoner = document.getElementById("summoner").value;
        contract_update_status(summoner);
    }
}



</script>



</body>
</html>



<!---

//garbedge
//--------------------------------------------------------------------------------------------------------



--->